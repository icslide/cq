<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡åº†å¸‚è‚²ä»ä¸­å­¦æ ¡2026å¹´ä¼šæŠ½å¥–ç³»ç»Ÿ</title>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 30px 20px;
            position: relative;
        }

        /* ä¸»å®¹å™¨ï¼šæŠ½å¥–åŒº+åå•åŒºæ¨ªå‘å¸ƒå±€ */
        .main-wrap {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }

        /* æŠ½å¥–ä¸»å®¹å™¨ */
        .lottery-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 60px 80px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.35);
            text-align: center;
            flex: 1;
            min-width: 600px;
        }

        /* ä¸­å¥–åå•æ‚¬æµ®æ¨¡å— */
        .win-list-aside {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            width: 320px;
            max-height: 80vh;
            overflow-y: auto;
            position: sticky;
            top: 30px;
            display: flex;
            flex-direction: column;
        }
        /* åå•å¤´éƒ¨ */
        .win-list-header {
            padding: 15px 20px;
            background-color: #1a2980;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .win-list-title {
            font-size: 18px;
            color: white;
            font-weight: 600;
        }
        .win-list-oper {
            display: flex;
            gap: 8px;
        }
        .list-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: white;
            background-color: rgba(255,255,255,0.3);
            transition: all 0.2s ease;
        }
        .list-btn:hover {
            background-color: rgba(255,255,255,0.5);
        }
        /* åå•å†…å®¹åŒº */
        .win-list-content {
            padding: 15px;
            flex: 1;
        }
        .win-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        .win-item:last-child {
            border-bottom: none;
        }
        .win-round { /* æ–°å¢ï¼šè½®æ•°æ ·å¼ */
            width: 40px;
            text-align: center;
            color: #f39c12;
            font-weight: 600;
        }
        .win-type {
            width: 50px;
            text-align: center;
            color: #1a2980;
            font-weight: 600;
        }
        .win-content {
            flex: 1;
            text-align: left;
            padding: 0 10px;
            color: #333;
        }
        .win-time {
            width: 90px;
            text-align: right;
            color: #999;
            font-size: 12px;
        }
        .empty-win-tip {
            text-align: center;
            color: #999;
            font-size: 14px;
        }
        /* åå•æ”¶èµ·æ ·å¼ */
        .win-list-aside.collapse {
            width: 40px;
            overflow: hidden;
        }
        .win-list-aside.collapse .win-list-header .win-list-title,
        .win-list-aside.collapse .win-list-oper .list-btn:not(.collapse-btn),
        .win-list-aside.collapse .win-list-content {
            display: none;
        }
        .win-list-aside.collapse .win-list-header {
            justify-content: center;
        }
        .win-list-aside.collapse .collapse-btn {
            transform: rotate(180deg);
        }

        /* æŠ½å¥–æ ‡é¢˜æ ·å¼ */
        .lottery-title {
            font-size: 46px;
            color: #1a2980;
            margin-bottom: 40px;
            font-weight: bold;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.12);
        }

        /* åˆ‡æ¢æ ‡ç­¾ */
        .tab-switch {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }

        .tab-btn {
            padding: 12px 30px;
            font-size: 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background-color: #e8f4f8;
            color: #1a2980;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background-color: #1a2980;
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background-color: #d1e7dd;
        }

        /* åé¢é€‰æ‹©åŒºåŸŸ */
        .quota-select {
            margin: 20px 0 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .quota-label {
            font-size: 22px;
            color: #2c3e50;
            font-weight: 600;
        }

        .quota-btn {
            padding: 10px 30px;
            font-size: 18px;
            border: 2px solid #26d0ce;
            border-radius: 8px;
            cursor: pointer;
            background-color: white;
            color: #1a2980;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .quota-btn.active {
            background-color: #1a2980;
            color: white;
            border-color: #1a2980;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content-panel {
            display: none;
        }

        .content-panel.active {
            display: block;
        }

        /* èŒƒå›´è®¾ç½®åŒºåŸŸ */
        .range-setting {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .range-label {
            font-size: 22px;
            color: #2c3e50;
            font-weight: 600;
        }

        .range-input {
            padding: 14px 18px;
            font-size: 20px;
            border: 2px solid #26d0ce;
            border-radius: 10px;
            width: 130px;
            text-align: center;
            outline: none;
        }

        .range-input:focus {
            border-color: #1a2980;
            box-shadow: 0 0 10px rgba(26, 41, 128, 0.25);
        }

        .range-separator {
            font-size: 26px;
            color: #7f8c8d;
            font-weight: bold;
        }

        /* Excelå¯¼å…¥åŒºåŸŸ */
        .excel-import {
            margin: 0 auto 20px;
            padding: 30px;
            background-color: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #26d0ce;
            max-width: 600px;
        }

        .import-label {
            font-size: 22px;
            color: #2c3e50;
            font-weight: 600;
            display: block;
            margin-bottom: 20px;
        }

        /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-btn {
            display: inline-block;
            padding: 12px 40px;
            font-size: 18px;
            background-color: #26d0ce;
            color: white;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background-color: #1a2980;
        }

        #excelFile {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-name {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 15px;
            display: block;
        }

        .parse-btn {
            padding: 10px 30px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            background-color: #1a2980;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .parse-btn:hover {
            background-color: #27ae60;
        }

        .tip-text {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .name-count-tip {
            font-size: 18px;
            color: #27ae60;
            font-weight: 600;
            margin-top: 10px;
        }

        /* æ˜¾ç¤ºåŒºåŸŸï¼ˆæ•°å­—/å§“åï¼‰ */
        .display-area {
            font-size: 40px;
            font-weight: bold;
            color: #e74c3c;
            margin: 40px 0;
            min-height: 280px;
            line-height: 60px;
            border: 6px solid #26d0ce;
            border-radius: 20px;
            background-color: #f8f9fa;
            letter-spacing: 4px;
            box-shadow: inset 0 0 25px rgba(0,0,0,0.08);
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .winner-item {
            background-color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 5px;
        }

        /* æŠ½å¥–æŒ‰é’®æ ·å¼ï¼ˆå•æŒ‰é’®ï¼‰ */
        .lottery-btn {
            padding: 25px 80px;
            font-size: 32px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
            min-width: 300px;
        }
        /* å¼€å§‹æŠ½å¥–æ ·å¼ï¼ˆç»¿è‰²ï¼‰ */
        .lottery-btn.start {
            background-color: #27ae60;
            color: white;
        }
        .lottery-btn.start:hover {
            background-color: #219653;
            transform: scale(1.05);
        }
        /* åœæ­¢æŠ½å¥–æ ·å¼ï¼ˆçº¢è‰²ï¼‰ */
        .lottery-btn.stop {
            background-color: #e74c3c;
            color: white;
        }
        .lottery-btn.stop:hover {
            background-color: #d32f2f;
            transform: scale(1.05);
        }

        /* ä¸­å¥–æç¤º */
        .win-tip {
            font-size: 36px;
            color: #f39c12;
            margin: 30px 0 0;
            font-weight: bold;
            display: none;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.15);
            animation: bounce 1s ease infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-12px); }
        }

        /* ç®¡ç†å…¥å£ */
        .admin-entrance {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: rgba(26, 41, 128, 0.8);
            color: white;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            z-index: 999;
        }

        .admin-entrance:hover {
            background-color: #1a2980;
        }

        /* è½®æ•°æ˜¾ç¤ºæ ·å¼ï¼ˆæ–°å¢ï¼‰ */
        .round-display {
            font-size: 20px;
            color: #1a2980;
            margin: 10px 0 20px;
            font-weight: 600;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        /* è½®æ•°æ§åˆ¶æŒ‰é’® */
        .round-control-btn {
            padding: 5px 15px;
            font-size: 16px;
            border: 1px solid #1a2980;
            border-radius: 6px;
            cursor: pointer;
            background-color: white;
            color: #1a2980;
            transition: all 0.2s ease;
        }

        .round-control-btn:hover {
            background-color: #1a2980;
            color: white;
        }

        /* å‰©ä½™åé¢æç¤ºï¼ˆæ–°å¢ï¼‰ */
        .remaining-tip {
            font-size: 16px;
            color: #27ae60;
            margin: 10px 0;
            font-weight: 500;
        }

        /* å“åº”å¼é€‚é… */
        @media (max-width: 1024px) {
            .main-wrap {
                flex-direction: column;
                align-items: center;
            }
            .lottery-container {
                min-width: 100%;
                padding: 40px 30px;
            }
            .win-list-aside {
                width: 100%;
                max-height: 300px;
                position: static;
            }
            .lottery-title {
                font-size: 32px;
            }
            .display-area {
                font-size: 28px;
                min-height: 200px;
                line-height: 40px;
                letter-spacing: 2px;
            }
            .lottery-btn {
                padding: 20px 60px;
                font-size: 24px;
                min-width: 200px;
            }
            .range-input {
                width: 100px;
                font-size: 18px;
            }
            .quota-btn {
                padding: 8px 20px;
                font-size: 16px;
            }
            .excel-import {
                padding: 20px;
            }
            .win-tip {
                font-size: 28px;
            }
            .round-display {
                font-size: 18px;
                flex-wrap: wrap;
            }
        }
    </style>
    <!-- å¼•å…¥å¤„ç†Excelçš„ç¬¬ä¸‰æ–¹åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <!-- ç®¡ç†é¡µé¢å…¥å£ -->
    <a href="admin.html" class="admin-entrance">ç®¡ç†åå°</a>

    <!-- ä¸»å®¹å™¨ï¼ŒåŒ…å«æŠ½å¥–åŒºå’Œåå•åŒº -->
    <div class="main-wrap">
        <!-- åŸæœ‰æŠ½å¥–å®¹å™¨ -->
        <div class="lottery-container">
            <h1 class="lottery-title">é‡åº†å¸‚è‚²ä»ä¸­å­¦æ ¡2026å¹´ä¼šæŠ½å¥–</h1>
            
            <!-- æ–°å¢ï¼šå½“å‰æŠ½å¥–è½®æ•°æ˜¾ç¤º + è½®æ•°æ§åˆ¶æŒ‰é’® -->
            <div class="round-display" id="roundDisplay">
                <span>å½“å‰æŠ½å¥–è½®æ•°ï¼š</span>
                <button class="round-control-btn" id="prevRoundBtn">ä¸Šä¸€è½®</button>
                <span id="currentRoundText">ç¬¬ 1 è½®</span>
                <button class="round-control-btn" id="nextRoundBtn">ä¸‹ä¸€è½®</button>
            </div>
            
            <!-- æ–°å¢ï¼šå‰©ä½™å¯æŠ½å¥–åé¢æç¤º -->
            <div class="remaining-tip" id="remainingTip">å‰©ä½™å¯æŠ½å¥–åé¢ï¼š--</div>

            <!-- åˆ‡æ¢æ ‡ç­¾ï¼šæ•°å­—æŠ½å¥–/å§“åæŠ½å¥– -->
            <div class="tab-switch">
                <button class="tab-btn active" data-tab="number-tab">æ•°å­—æŠ½å¥–</button>
                <button class="tab-btn" data-tab="name-tab">æ•™å¸ˆå§“åæŠ½å¥–</button>
            </div>

            <!-- åé¢é€‰æ‹©åŒºåŸŸ -->
            <div class="quota-select">
                <span class="quota-label">æœ¬æ¬¡æŠ½å¥–åé¢ï¼š</span>
                <button class="quota-btn active" data-quota="1">1ä¸ªåé¢</button>
                <button class="quota-btn" data-quota="10">10ä¸ªåé¢</button>
            </div>

            <!-- æ•°å­—æŠ½å¥–é¢æ¿ -->
            <div class="content-panel active" id="number-tab">
                <div class="range-setting">
                    <span class="range-label">æŠ½å¥–èŒƒå›´ï¼š</span>
                    <input type="number" class="range-input" id="minNumInput" value="1" min="1" placeholder="æœ€å°å€¼">
                    <span class="range-separator">-</span>
                    <input type="number" class="range-input" id="maxNumInput" value="99" min="1" placeholder="æœ€å¤§å€¼">
                </div>
            </div>

            <!-- å§“åæŠ½å¥–é¢æ¿ï¼ˆExcelå¯¼å…¥ï¼‰ -->
            <div class="content-panel" id="name-tab">
                <div class="excel-import">
                    <span class="import-label">å¯¼å…¥æ•™å¸ˆå§“åï¼ˆExcelæ–‡ä»¶ï¼‰ï¼š</span>
                    <!-- æ–‡ä»¶ä¸Šä¼ æŒ‰é’® -->
                    <div class="file-upload">
                        <span class="upload-btn">é€‰æ‹©Excelæ–‡ä»¶</span>
                        <input type="file" id="excelFile" accept=".xlsx, .xls">
                    </div>
                    <!-- æ˜¾ç¤ºé€‰ä¸­çš„æ–‡ä»¶å -->
                    <span class="file-name" id="fileName">æœªé€‰æ‹©æ–‡ä»¶</span>
                    <!-- è§£ææŒ‰é’® -->
                    <button class="parse-btn" id="parseExcelBtn" disabled>è§£æExcelåå•</button>
                    <!-- æç¤ºä¿¡æ¯ -->
                    <p class="tip-text">ğŸ“Œ æç¤ºï¼šExcelæ–‡ä»¶è¦æ±‚ - ç¬¬ä¸€åˆ—ä¸ºæ•™å¸ˆå§“åï¼Œæ— è¡¨å¤´ï¼ˆç¤ºä¾‹ï¼šA1=å¼ ä¸‰, A2=æå››, A3=ç‹äº”ï¼‰</p>
                    <p class="tip-text">æ”¯æŒæ ¼å¼ï¼š.xlsx / .xlsï¼Œè¯·å‹¿ä¸Šä¼ ç©ºæ–‡ä»¶æˆ–æ ¼å¼é”™è¯¯çš„æ–‡ä»¶</p>
                    <!-- å§“åæ•°é‡æç¤º -->
                    <p class="name-count-tip" id="nameCountTip">å½“å‰æœªå¯¼å…¥ä»»ä½•å§“å</p>
                </div>
            </div>

            <!-- æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="display-area" id="displayArea">0</div>
            
            <!-- å•æŠ½å¥–æŒ‰é’® -->
            <button class="lottery-btn start" id="lotteryBtn">å¼€å§‹æŠ½å¥–</button>
            
            <!-- ä¸­å¥–æç¤º -->
            <div class="win-tip" id="winTip">æ­å–œä¸­å¥–ï¼ğŸ‰</div>
        </div>

        <!-- å³ä¾§ä¸­å¥–åå•å±•ç¤ºæ¨¡å— -->
        <div class="win-list-aside" id="winListAside">
            <div class="win-list-header">
                <div class="win-list-title">ä¸­å¥–åå•å®æ—¶å±•ç¤º</div>
                <div class="win-list-oper">
                    <button class="list-btn refresh-list-btn" id="refreshListBtn">åˆ·æ–°</button>
                    <button class="list-btn download-list-btn" id="downloadListBtn">ä¸‹è½½åå•</button>
                    <button class="list-btn collapse-btn" id="collapseListBtn">æ”¶èµ·</button>
                </div>
            </div>
            <div class="win-list-content" id="winListContent">
                <div class="empty-win-tip">æš‚æ— ä¸­å¥–è®°å½•</div>
            </div>
        </div>
    </div>

    <script>
        // ====================== å…¨å±€å˜é‡ ======================
        // æŠ½å¥–çŠ¶æ€
        let isLotteryRunning = false;
        // æŠ½å¥–å®šæ—¶å™¨
        let lotteryTimer = null;
        // å½“å‰é€‰ä¸­çš„æ ‡ç­¾ï¼ˆæ•°å­—/å§“åï¼‰
        let currentTab = 'number-tab';
        // å½“å‰é€‰ä¸­çš„æŠ½å¥–åé¢
        let currentQuota = 1;
        // å½“å‰æŠ½å¥–è½®æ•°
        let currentRound = parseInt(localStorage.getItem('lotteryCurrentRound')) || 1;
        // å·²ä¸­å¥–çš„å·ç /å§“åé›†åˆï¼ˆæ ¸å¿ƒï¼šé˜²é‡å¤ä¸­å¥–ï¼‰
        let wonSet = JSON.parse(localStorage.getItem('lotteryWonSet')) || new Set();
        // å¯¼å…¥çš„å§“ååˆ—è¡¨
        let nameList = JSON.parse(localStorage.getItem('lotteryNameList')) || [];
        // ä¸­å¥–åå•
        let winList = JSON.parse(localStorage.getItem('lotteryWinList')) || [];

        // ====================== è·å–é¡µé¢å…ƒç´  ======================
        const tabBtns = document.querySelectorAll('.tab-btn');
        const quotaBtns = document.querySelectorAll('.quota-btn');
        const contentPanels = document.querySelectorAll('.content-panel');
        const minNumInput = document.getElementById('minNumInput');
        const maxNumInput = document.getElementById('maxNumInput');
        const excelFile = document.getElementById('excelFile');
        const fileName = document.getElementById('fileName');
        const parseExcelBtn = document.getElementById('parseExcelBtn');
        const nameCountTip = document.getElementById('nameCountTip');
        const displayArea = document.getElementById('displayArea');
        const lotteryBtn = document.getElementById('lotteryBtn');
        const winTip = document.getElementById('winTip');
        const roundDisplay = document.getElementById('roundDisplay');
        const currentRoundText = document.getElementById('currentRoundText');
        const prevRoundBtn = document.getElementById('prevRoundBtn');
        const nextRoundBtn = document.getElementById('nextRoundBtn');
        const remainingTip = document.getElementById('remainingTip');
        const winListAside = document.getElementById('winListAside');
        const winListContent = document.getElementById('winListContent');
        const refreshListBtn = document.getElementById('refreshListBtn');
        const downloadListBtn = document.getElementById('downloadListBtn');
        const collapseListBtn = document.getElementById('collapseListBtn');

        // ====================== åˆå§‹åŒ– ======================
        window.addEventListener('load', function() {
            // åˆå§‹åŒ–è½®æ•°æ˜¾ç¤º
            updateRoundDisplay();
            // åˆå§‹åŒ–å‰©ä½™åé¢æç¤º
            updateRemainingTip();
            // åˆå§‹åŒ–ä¸­å¥–åå•æ˜¾ç¤º
            renderWinList();
            
            // ç»‘å®šè½®æ•°æ§åˆ¶æŒ‰é’®äº‹ä»¶
            prevRoundBtn.addEventListener('click', goToPrevRound);
            nextRoundBtn.addEventListener('click', goToNextRound);
            
            // ç»‘å®šæ ‡ç­¾åˆ‡æ¢äº‹ä»¶
            tabBtns.forEach(btn => {
                btn.addEventListener('click', switchTab);
            });
            // ç»‘å®šåé¢é€‰æ‹©äº‹ä»¶
            quotaBtns.forEach(btn => {
                btn.addEventListener('click', selectQuota);
            });
            // ç»‘å®šExcelä¸Šä¼ äº‹ä»¶
            excelFile.addEventListener('change', handleExcelSelect);
            // ç»‘å®šè§£æExceläº‹ä»¶
            parseExcelBtn.addEventListener('click', parseExcel);
            // ç»‘å®šæŠ½å¥–æŒ‰é’®äº‹ä»¶
            lotteryBtn.addEventListener('click', toggleLottery);
            // ç»‘å®šåå•åˆ·æ–°äº‹ä»¶
            refreshListBtn.addEventListener('click', renderWinList);
            // ç»‘å®šåå•ä¸‹è½½äº‹ä»¶
            downloadListBtn.addEventListener('click', downloadWinList);
            // ç»‘å®šåå•æ”¶èµ·/å±•å¼€äº‹ä»¶
            collapseListBtn.addEventListener('click', toggleListCollapse);

            // ç›‘å¬æœ¬åœ°å­˜å‚¨å˜åŒ–ï¼ˆåŒæ­¥ç®¡ç†åå°ä¿®æ”¹ï¼‰
            window.addEventListener('storage', function(e) {
                if (e.key === 'lotteryCurrentRound') {
                    currentRound = parseInt(e.newValue) || 1;
                    updateRoundDisplay();
                }
                if (e.key === 'lotteryWonSet') {
                    wonSet = JSON.parse(e.newValue) || new Set();
                    updateRemainingTip();
                }
                if (e.key === 'lotteryWinList') {
                    winList = JSON.parse(e.newValue) || [];
                    renderWinList();
                }
                if (e.key === 'lotteryNameList') {
                    nameList = JSON.parse(e.newValue) || [];
                    updateRemainingTip();
                    nameCountTip.textContent = `å·²å¯¼å…¥ ${nameList.length} ä¸ªå§“å`;
                }
            });
        });

        // ====================== è½®æ•°ç®¡ç†åŠŸèƒ½ï¼ˆä¿®å¤è½®æ•°å…¨ä¸º1çš„æ ¸å¿ƒï¼‰ ======================
        /**
         * æ›´æ–°è½®æ•°æ˜¾ç¤º
         */
        function updateRoundDisplay() {
            currentRoundText.textContent = `ç¬¬ ${currentRound} è½®`;
            // ç¦ç”¨/å¯ç”¨ä¸Šä¸€è½®æŒ‰é’®ï¼ˆé˜²æ­¢è½®æ•°å°äº1ï¼‰
            prevRoundBtn.disabled = currentRound <= 1;
            prevRoundBtn.style.opacity = currentRound <= 1 ? '0.5' : '1';
            // æŒä¹…åŒ–è½®æ•°
            localStorage.setItem('lotteryCurrentRound', currentRound);
        }

        /**
         * ä¸Šä¸€è½®
         */
        function goToPrevRound() {
            if (currentRound > 1) {
                currentRound--;
                updateRoundDisplay();
            }
        }

        /**
         * ä¸‹ä¸€è½®ï¼ˆæŠ½å¥–å®Œæˆåå¯æ‰‹åŠ¨åˆ‡æ¢ï¼Œä¹Ÿå¯åœ¨æŠ½å¥–åè‡ªåŠ¨åˆ‡æ¢ï¼‰
         */
        function goToNextRound() {
            currentRound++;
            updateRoundDisplay();
        }

        // ====================== æ ¸å¿ƒåŠŸèƒ½ï¼šé˜²é‡å¤ä¸­å¥–ç›¸å…³ ======================
        /**
         * æ›´æ–°å‰©ä½™å¯æŠ½å¥–åé¢æç¤º
         */
        function updateRemainingTip() {
            if (currentTab === 'number-tab') {
                // æ•°å­—æŠ½å¥–ï¼šè®¡ç®—èŒƒå›´å…§æœªä¸­å¥–çš„æ•°é‡
                const min = parseInt(minNumInput.value) || 1;
                const max = parseInt(maxNumInput.value) || 99;
                const total = max - min + 1;
                const wonCount = Array.from(wonSet).filter(item => !isNaN(item) && item >= min && item <= max).length;
                const remaining = total - wonCount;
                remainingTip.textContent = `å‰©ä½™å¯æŠ½å¥–åé¢ï¼š${remaining} (æ€»${total}ä¸ª)`;
            } else {
                // å§“åæŠ½å¥–ï¼šè®¡ç®—å¯¼å…¥åå•ä¸­æœªä¸­å¥–çš„æ•°é‡
                const total = nameList.length;
                const wonCount = Array.from(wonSet).filter(item => nameList.includes(item)).length;
                const remaining = total - wonCount;
                remainingTip.textContent = `å‰©ä½™å¯æŠ½å¥–åé¢ï¼š${remaining} (æ€»${total}ä¸ª)`;
            }
        }

        /**
         * è¿‡æ»¤å‡ºæœªä¸­å¥–çš„å€™é€‰åˆ—è¡¨
         * @returns {Array} æœªä¸­å¥–çš„å€™é€‰æ•°ç»„
         */
        function getAvailableCandidates() {
            let candidates = [];
            if (currentTab === 'number-tab') {
                // æ•°å­—æŠ½å¥–ï¼šç”ŸæˆèŒƒå›´å…§æœªä¸­å¥–çš„æ•°å­—
                const min = parseInt(minNumInput.value) || 1;
                const max = parseInt(maxNumInput.value) || 99;
                for (let i = min; i <= max; i++) {
                    if (!wonSet.has(i.toString())) {
                        candidates.push(i.toString());
                    }
                }
            } else {
                // å§“åæŠ½å¥–ï¼šè¿‡æ»¤å‡ºæœªä¸­å¥–çš„å§“å
                candidates = nameList.filter(name => !wonSet.has(name));
            }
            return candidates;
        }

        /**
         * æ ‡è®°ä¸ºå·²ä¸­å¥–ï¼ˆåŠ å…¥wonSetå¹¶æŒä¹…åŒ–ï¼‰
         * @param {string} item ä¸­å¥–çš„å·ç /å§“å
         */
        function markAsWon(item) {
            wonSet.add(item);
            // æŒä¹…åŒ–åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå…¼å®¹ç®¡ç†åå°ï¼‰
            localStorage.setItem('lotteryWonSet', JSON.stringify(Array.from(wonSet)));
            // æ›´æ–°å‰©ä½™åé¢æç¤º
            updateRemainingTip();
        }

        // ====================== åŸæœ‰åŠŸèƒ½ï¼šæ ‡ç­¾åˆ‡æ¢ ======================
        function switchTab(e) {
            const targetTab = e.target.dataset.tab;
            // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
            tabBtns.forEach(btn => btn.classList.remove('active'));
            contentPanels.forEach(panel => panel.classList.remove('active'));
            // æ¿€æ´»å½“å‰æ ‡ç­¾
            e.target.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
            // æ›´æ–°å½“å‰æ ‡ç­¾
            currentTab = targetTab;
            // é‡ç½®æ˜¾ç¤ºåŒºåŸŸ
            displayArea.textContent = '0';
            // æ›´æ–°å‰©ä½™åé¢æç¤º
            updateRemainingTip();
        }

        // ====================== åŸæœ‰åŠŸèƒ½ï¼šåé¢é€‰æ‹© ======================
        function selectQuota(e) {
            const quota = parseInt(e.target.dataset.quota);
            // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
            quotaBtns.forEach(btn => btn.classList.remove('active'));
            // æ¿€æ´»å½“å‰åé¢
            e.target.classList.add('active');
            // æ›´æ–°å½“å‰åé¢
            currentQuota = quota;
        }

        // ====================== åŸæœ‰åŠŸèƒ½ï¼šExcelå¤„ç† ======================
        function handleExcelSelect(e) {
            const file = e.target.files[0];
            if (file) {
                fileName.textContent = file.name;
                parseExcelBtn.disabled = false;
                // å­˜å‚¨æ–‡ä»¶å¯¹è±¡
                parseExcelBtn.dataset.file = file.name;
                parseExcelBtn.file = file;
            } else {
                fileName.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                parseExcelBtn.disabled = true;
                delete parseExcelBtn.file;
            }
        }

        function parseExcel() {
            if (!parseExcelBtn.file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    // è½¬æ¢ä¸ºæ•°ç»„ï¼ˆåªå–ç¬¬ä¸€åˆ—ï¼‰
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: ['name'] });
                    // è¿‡æ»¤ç©ºå€¼ï¼Œæå–å§“ååˆ—è¡¨
                    nameList = jsonData.map(item => item.name).filter(name => name && typeof name === 'string');
                    // å»é‡
                    nameList = [...new Set(nameList)];
                    // æŒä¹…åŒ–å§“ååˆ—è¡¨
                    localStorage.setItem('lotteryNameList', JSON.stringify(nameList));
                    // æ›´æ–°æç¤º
                    nameCountTip.textContent = `å·²å¯¼å…¥ ${nameList.length} ä¸ªå§“å`;
                    // æ›´æ–°å‰©ä½™åé¢æç¤º
                    updateRemainingTip();
                    alert(`æˆåŠŸè§£æExcelæ–‡ä»¶ï¼Œå…±å¯¼å…¥ ${nameList.length} ä¸ªæ•™å¸ˆå§“åï¼`);
                } catch (error) {
                    alert('Excelæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼');
                    console.error('Excelè§£æé”™è¯¯ï¼š', error);
                }
            };
            reader.readAsArrayBuffer(parseExcelBtn.file);
        }

        // ====================== æ ¸å¿ƒåŠŸèƒ½ï¼šæŠ½å¥–é€»è¾‘ï¼ˆæ–°å¢é˜²é‡å¤+ä¿®å¤è½®æ•°ï¼‰ ======================
        function toggleLottery() {
            if (isLotteryRunning) {
                // åœæ­¢æŠ½å¥–
                stopLottery();
                // æŠ½å¥–å®Œæˆåè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€è½®ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯æ‰‹åŠ¨åˆ‡æ¢ï¼‰
                // goToNextRound(); 
            } else {
                // å¼€å§‹æŠ½å¥–
                startLottery();
            }
        }

        function startLottery() {
            // éªŒè¯æŠ½å¥–æ¡ä»¶
            if (currentTab === 'name-tab' && nameList.length === 0) {
                alert('è¯·å…ˆå¯¼å…¥æ•™å¸ˆå§“åExcelæ–‡ä»¶ï¼');
                return;
            }

            // è·å–æœªä¸­å¥–çš„å€™é€‰åˆ—è¡¨
            const candidates = getAvailableCandidates();
            if (candidates.length === 0) {
                alert('æ‰€æœ‰åé¢å·²ä¸­å¥–ï¼Œæ— å¯ç”¨æŠ½å¥–åé¢ï¼');
                return;
            }
            if (candidates.length < currentQuota) {
                alert(`å‰©ä½™å¯æŠ½å¥–åé¢ä¸è¶³ï¼ˆä»…${candidates.length}ä¸ªï¼‰ï¼Œå·²è‡ªåŠ¨è°ƒæ•´ä¸º${candidates.length}ä¸ªåé¢ï¼`);
                currentQuota = candidates.length;
                // æ›´æ–°åé¢æŒ‰é’®é€‰ä¸­çŠ¶æ€
                quotaBtns.forEach(btn => {
                    if (parseInt(btn.dataset.quota) === currentQuota) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            lotteryBtn.classList.remove('start');
            lotteryBtn.classList.add('stop');
            lotteryBtn.textContent = 'åœæ­¢æŠ½å¥–';
            winTip.style.display = 'none';
            isLotteryRunning = true;

            // å¼€å§‹æ»šåŠ¨æŠ½å¥–
            lotteryTimer = setInterval(() => {
                const randomItems = getRandomItems(candidates, currentQuota);
                renderDisplayArea(randomItems);
            }, 50);
        }

        function stopLottery() {
            // æ¸…é™¤å®šæ—¶å™¨
            clearInterval(lotteryTimer);
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            lotteryBtn.classList.remove('stop');
            lotteryBtn.classList.add('start');
            lotteryBtn.textContent = 'å¼€å§‹æŠ½å¥–';
            isLotteryRunning = false;

            // è·å–æœ€ç»ˆä¸­å¥–ç»“æœ
            const candidates = getAvailableCandidates();
            const winners = getRandomItems(candidates, currentQuota);
            // æ¸²æŸ“ä¸­å¥–ç»“æœ
            renderDisplayArea(winners);
            // æ˜¾ç¤ºä¸­å¥–æç¤º
            winTip.style.display = 'block';

            // æ ‡è®°ä¸­å¥–è€…ä¸ºå·²ä¸­å¥–ï¼ˆæ ¸å¿ƒï¼šé˜²é‡å¤ï¼‰
            winners.forEach(winner => markAsWon(winner));

            // è®°å½•ä¸­å¥–ä¿¡æ¯ï¼ˆä½¿ç”¨å½“å‰æœ€æ–°è½®æ•°ï¼‰
            recordWinInfo(winners);
            // æ›´æ–°ä¸­å¥–åå•æ˜¾ç¤º
            renderWinList();
        }

        /**
         * ä»å€™é€‰åˆ—è¡¨ä¸­éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„å…ƒç´ 
         * @param {Array} candidates å€™é€‰åˆ—è¡¨
         * @param {number} count é€‰æ‹©æ•°é‡
         * @returns {Array} é€‰ä¸­çš„å…ƒç´ æ•°ç»„
         */
        function getRandomItems(candidates, count) {
            // æ·±æ‹·è´é¿å…ä¿®æ”¹åŸæ•°ç»„
            const temp = [...candidates];
            const result = [];
            // éšæœºé€‰æ‹©countä¸ªå…ƒç´ 
            for (let i = 0; i < count && temp.length > 0; i++) {
                const randomIndex = Math.floor(Math.random() * temp.length);
                result.push(temp.splice(randomIndex, 1)[0]);
            }
            return result;
        }

        /**
         * æ¸²æŸ“æ˜¾ç¤ºåŒºåŸŸ
         * @param {Array} items è¦æ˜¾ç¤ºçš„å·ç /å§“åæ•°ç»„
         */
        function renderDisplayArea(items) {
            displayArea.innerHTML = '';
            items.forEach(item => {
                const winnerItem = document.createElement('div');
                winnerItem.className = 'winner-item';
                winnerItem.textContent = item;
                displayArea.appendChild(winnerItem);
            });
            // å…¼å®¹å•ä¸ªå…ƒç´ æ˜¾ç¤º
            if (items.length === 0) {
                displayArea.textContent = '0';
            }
        }

        /**
         * è®°å½•ä¸­å¥–ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä½¿ç”¨å½“å‰è½®æ•°ï¼‰
         * @param {Array} winners ä¸­å¥–è€…æ•°ç»„
         */
        function recordWinInfo(winners) {
            const now = new Date();
            const timeStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            const type = currentTab === 'number-tab' ? 'æ•°å­—' : 'å§“å';
            
            winners.forEach(winner => {
                winList.push({
                    round: currentRound, // ä¸å†å›ºå®šä¸º1ï¼Œä½¿ç”¨å½“å‰è½®æ•°
                    type: type,
                    content: winner,
                    time: timeStr
                });
            });

            // æŒä¹…åŒ–ä¸­å¥–åå•
            localStorage.setItem('lotteryWinList', JSON.stringify(winList));
        }

        // ====================== ä¸­å¥–åå•ç›¸å…³ ======================
        function renderWinList() {
            if (winList.length === 0) {
                winListContent.innerHTML = '<div class="empty-win-tip">æš‚æ— ä¸­å¥–è®°å½•</div>';
                return;
            }

            // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨æœ€å‰é¢ï¼‰
            const reversedList = [...winList].reverse();
            let html = '';
            reversedList.forEach((item, index) => {
                html += `
                    <div class="win-item">
                        <div class="win-round">${item.round}è½®</div>
                        <div class="win-type">${item.type}</div>
                        <div class="win-content">${item.content}</div>
                        <div class="win-time">${item.time}</div>
                    </div>
                `;
            });
            winListContent.innerHTML = html;
        }

        function downloadWinList() {
            if (winList.length === 0) {
                alert('æš‚æ— ä¸­å¥–è®°å½•å¯ä¸‹è½½ï¼');
                return;
            }

            // è½¬æ¢ä¸ºCSVæ ¼å¼
            const header = 'æŠ½å¥–è½®æ•°,æŠ½å¥–ç±»å‹,ä¸­å¥–å†…å®¹,ä¸­å¥–æ—¶é—´\n';
            const content = winList.map(item => `${item.round},${item.type},${item.content},${item.time}`).join('\n');
            const csv = header + content;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `è‚²ä»ä¸­å­¦2026å¹´ä¼šä¸­å¥–åå•_${new Date().getTime()}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function toggleListCollapse() {
            winListAside.classList.toggle('collapse');
        }
    </script>
</body>
</html>
