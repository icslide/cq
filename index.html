<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重庆市育仁中学校2025年会抽奖系统</title>
    <link rel="stylesheet" href="style.css">
    <!-- 引入SheetJS库处理Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>重庆市育仁中学校2025年会抽奖</h1>
        
        <!-- 设置区域 -->
        <div class="settings">
            <h2>抽奖设置</h2>
            <div class="settings-item">
                <label for="minNum">数字最小值：</label>
                <input type="number" id="minNum" value="1" min="1">
            </div>
            <div class="settings-item">
                <label for="maxNum">数字最大值：</label>
                <input type="number" id="maxNum" value="100" min="1">
            </div>
            <div class="settings-item">
                <label for="drawCount">抽取数量：</label>
                <select id="drawCount">
                    <option value="1">1个</option>
                    <option value="10">10个</option>
                </select>
            </div>
            <div class="settings-item">
                <label for="excelUpload">导入教师名单：</label>
                <input type="file" id="excelUpload" accept=".xlsx,.xls">
            </div>
        </div>

        <!-- 抽奖区域 -->
        <div class="lottery-area">
            <div class="number-display" id="resultDisplay">点击开始抽奖</div>
            <button class="btn" id="startBtn">开始抽奖</button>
            <button class="btn" id="stopBtn" disabled>停止抽奖</button>
        </div>

        <!-- 中奖名单 -->
        <div class="winners-list">
            <h2>中奖名单</h2>
            <table class="winners-table">
                <thead>
                    <tr>
                        <th>抽奖轮数</th>
                        <th>中奖号码/姓名</th>
                    </tr>
                </thead>
                <tbody id="winnersTableBody">
                    <!-- 中奖记录会动态显示在这里 -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 全局变量
        let lotteryInterval = null;
        let isDrawing = false;
        let teacherList = []; // 存储导入的教师名单
        let usedNumbers = []; // 已中奖的号码/姓名
        let currentRound = 0; // 当前抽奖轮数

        // DOM元素
        const resultDisplay = document.getElementById('resultDisplay');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const minNumInput = document.getElementById('minNum');
        const maxNumInput = document.getElementById('maxNum');
        const drawCountSelect = document.getElementById('drawCount');
        const excelUpload = document.getElementById('excelUpload');
        const winnersTableBody = document.getElementById('winnersTableBody');

        // 初始化：从本地存储加载数据
        function init() {
            // 加载已中奖记录
            const savedWinners = localStorage.getItem('lotteryWinners');
            const savedUsedNumbers = localStorage.getItem('usedNumbers');
            const savedRound = localStorage.getItem('currentRound');
            
            if (savedWinners) {
                renderWinnersList(JSON.parse(savedWinners));
            }
            if (savedUsedNumbers) {
                usedNumbers = JSON.parse(savedUsedNumbers);
            }
            if (savedRound) {
                currentRound = parseInt(savedRound);
            }

            // 监听Excel上传
            excelUpload.addEventListener('change', handleExcelUpload);

            // 抽奖按钮事件
            startBtn.addEventListener('click', startLottery);
            stopBtn.addEventListener('click', stopLottery);

            // 实时监听本地存储变化（同步管理页面的修改）
            window.addEventListener('storage', handleStorageChange);

            // 定时刷新中奖名单（防止手动修改本地存储）
            setInterval(refreshWinnersList, 1000);
        }

        // 处理Excel上传
        function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 读取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 转换为JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // 提取教师姓名（假设Excel第一列是姓名，字段名为"姓名"或第一个字段）
                    if (jsonData.length > 0) {
                        const nameKey = Object.keys(jsonData[0])[0];
                        teacherList = jsonData.map(item => item[nameKey]).filter(name => name);
                        alert(`成功导入 ${teacherList.length} 位教师名单！`);
                        
                        // 更新数字范围为教师名单长度
                        minNumInput.value = 1;
                        maxNumInput.value = teacherList.length;
                    } else {
                        alert('Excel中未读取到有效数据！');
                    }
                } catch (error) {
                    console.error('Excel解析失败：', error);
                    alert('Excel解析失败，请检查文件格式！');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 开始抽奖
        function startLottery() {
            if (isDrawing) return;

            const minNum = parseInt(minNumInput.value) || 1;
            const maxNum = parseInt(maxNumInput.value) || 100;
            const drawCount = parseInt(drawCountSelect.value) || 1;

            // 检查是否还有未中奖的号码
            const totalNumbers = maxNum - minNum + 1;
            if (usedNumbers.length >= totalNumbers) {
                alert('所有号码都已中奖，无法继续抽奖！');
                return;
            }

            isDrawing = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;

            // 开始滚动显示随机数
            lotteryInterval = setInterval(() => {
                let displayContent = '';
                for (let i = 0; i < drawCount; i++) {
                    // 生成未中奖的随机数
                    let randomNum;
                    do {
                        randomNum = Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;
                    } while (usedNumbers.includes(randomNum));
                    
                    // 如果有教师名单，显示姓名，否则显示数字
                    const displayText = teacherList[randomNum - 1] || randomNum;
                    displayContent += displayText + (i < drawCount - 1 ? ' | ' : '');
                }
                resultDisplay.textContent = displayContent;
            }, 50);
        }

        // 停止抽奖
        function stopLottery() {
            if (!isDrawing) return;

            clearInterval(lotteryInterval);
            isDrawing = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;

            // 获取最终中奖结果
            const winningResults = resultDisplay.textContent.split(' | ');
            const minNum = parseInt(minNumInput.value) || 1;
            
            // 记录中奖号码（数字）和结果（姓名/数字）
            const winningNumbers = winningResults.map(result => {
                // 如果是姓名，转换为对应的数字
                if (teacherList.length > 0) {
                    const index = teacherList.findIndex(name => name === result);
                    return index + 1;
                }
                return parseInt(result);
            });

            // 更新已中奖号码列表
            usedNumbers = [...usedNumbers, ...winningNumbers];
            currentRound++;

            // 保存中奖记录
            const winnersRecord = {
                round: currentRound,
                results: winningResults
            };

            // 从本地存储获取现有记录
            const savedWinners = JSON.parse(localStorage.getItem('lotteryWinners') || '[]');
            savedWinners.push(winnersRecord);

            // 保存到本地存储
            localStorage.setItem('lotteryWinners', JSON.stringify(savedWinners));
            localStorage.setItem('usedNumbers', JSON.stringify(usedNumbers));
            localStorage.setItem('currentRound', currentRound.toString());

            // 更新中奖名单显示
            renderWinnersList(savedWinners);

            alert(`恭喜！第${currentRound}轮中奖者：${winningResults.join('、')}`);
        }

        // 渲染中奖名单
        function renderWinnersList(winners) {
            winnersTableBody.innerHTML = '';
            if (winners.length === 0) {
                winnersTableBody.innerHTML = '<tr><td colspan="2">暂无中奖记录</td></tr>';
                return;
            }

            winners.forEach(record => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${record.round}</td>
                    <td>${record.results.join('、')}</td>
                `;
                winnersTableBody.appendChild(tr);
            });
        }

        // 刷新中奖名单
        function refreshWinnersList() {
            const savedWinners = localStorage.getItem('lotteryWinners');
            if (savedWinners) {
                renderWinnersList(JSON.parse(savedWinners));
            }
        }

        // 处理本地存储变化（同步管理页面修改）
        function handleStorageChange(e) {
            if (e.key === 'lotteryWinners' || e.key === 'usedNumbers' || e.key === 'currentRound') {
                refreshWinnersList();
                if (e.key === 'usedNumbers') {
                    usedNumbers = JSON.parse(e.newValue || '[]');
                }
                if (e.key === 'currentRound') {
                    currentRound = parseInt(e.newValue || 0);
                }
            }
        }

        // 初始化
        window.onload = init;
    </script>
</body>
</html>
