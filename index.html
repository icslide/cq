<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡åº†å¸‚è‚²ä»ä¸­å­¦æ ¡2026å¹´ä¼šæŠ½å¥–ç³»ç»Ÿ</title>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 30px 20px;
            position: relative;
        }

        /* ä¸»å®¹å™¨ï¼šæŠ½å¥–åŒº+åå•åŒºæ¨ªå‘å¸ƒå±€ */
        .main-wrap {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }

        /* æŠ½å¥–ä¸»å®¹å™¨ */
        .lottery-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 60px 80px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.35);
            text-align: center;
            flex: 1;
            min-width: 600px;
        }

        /* ä¸­å¥–åå•æ‚¬æµ®æ¨¡å— */
        .win-list-aside {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            width: 320px;
            max-height: 80vh;
            overflow-y: auto;
            position: sticky;
            top: 30px;
            display: flex;
            flex-direction: column;
        }
        /* åå•å¤´éƒ¨ */
        .win-list-header {
            padding: 15px 20px;
            background-color: #1a2980;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .win-list-title {
            font-size: 18px;
            color: white;
            font-weight: 600;
        }
        .win-list-oper {
            display: flex;
            gap: 8px;
        }
        .list-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: white;
            background-color: rgba(255,255,255,0.3);
            transition: all 0.2s ease;
        }
        .list-btn:hover {
            background-color: rgba(255,255,255,0.5);
        }
        /* åå•å†…å®¹åŒº */
        .win-list-content {
            padding: 15px;
            flex: 1;
        }
        .win-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        .win-item:last-child {
            border-bottom: none;
        }
        .win-round { /* æ–°å¢ï¼šè½®æ•°æ ·å¼ */
            width: 40px;
            text-align: center;
            color: #f39c12;
            font-weight: 600;
        }
        .win-type {
            width: 50px;
            text-align: center;
            color: #1a2980;
            font-weight: 600;
        }
        .win-content {
            flex: 1;
            text-align: left;
            padding: 0 10px;
            color: #333;
        }
        .win-time {
            width: 90px;
            text-align: right;
            color: #999;
            font-size: 12px;
        }
        .empty-win-tip {
            text-align: center;
            color: #999;
            font-size: 14px;
        }
        /* åå•æ”¶èµ·æ ·å¼ */
        .win-list-aside.collapse {
            width: 40px;
            overflow: hidden;
        }
        .win-list-aside.collapse .win-list-header .win-list-title,
        .win-list-aside.collapse .win-list-oper .list-btn:not(.collapse-btn),
        .win-list-aside.collapse .win-list-content {
            display: none;
        }
        .win-list-aside.collapse .win-list-header {
            justify-content: center;
        }
        .win-list-aside.collapse .collapse-btn {
            transform: rotate(180deg);
        }

        /* æŠ½å¥–æ ‡é¢˜æ ·å¼ */
        .lottery-title {
            font-size: 46px;
            color: #1a2980;
            margin-bottom: 40px;
            font-weight: bold;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.12);
        }

        /* åˆ‡æ¢æ ‡ç­¾ */
        .tab-switch {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }

        .tab-btn {
            padding: 12px 30px;
            font-size: 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background-color: #e8f4f8;
            color: #1a2980;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background-color: #1a2980;
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background-color: #d1e7dd;
        }

        /* åé¢é€‰æ‹©åŒºåŸŸ */
        .quota-select {
            margin: 20px 0 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .quota-label {
            font-size: 22px;
            color: #2c3e50;
            font-weight: 600;
        }

        .quota-btn {
            padding: 10px 30px;
            font-size: 18px;
            border: 2px solid #26d0ce;
            border-radius: 8px;
            cursor: pointer;
            background-color: white;
            color: #1a2980;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .quota-btn.active {
            background-color: #1a2980;
            color: white;
            border-color: #1a2980;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content-panel {
            display: none;
        }

        .content-panel.active {
            display: block;
        }

        /* èŒƒå›´è®¾ç½®åŒºåŸŸ */
        .range-setting {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .range-label {
            font-size: 22px;
            color: #2c3e50;
            font-weight: 600;
        }

        .range-input {
            padding: 14px 18px;
            font-size: 20px;
            border: 2px solid #26d0ce;
            border-radius: 10px;
            width: 130px;
            text-align: center;
            outline: none;
        }

        .range-input:focus {
            border-color: #1a2980;
            box-shadow: 0 0 10px rgba(26, 41, 128, 0.25);
        }

        .range-separator {
            font-size: 26px;
            color: #7f8c8d;
            font-weight: bold;
        }

        /* Excelå¯¼å…¥åŒºåŸŸ */
        .excel-import {
            margin: 0 auto 20px;
            padding: 30px;
            background-color: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #26d0ce;
            max-width: 600px;
        }

        .import-label {
            font-size: 22px;
            color: #2c3e50;
            font-weight: 600;
            display: block;
            margin-bottom: 20px;
        }

        /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-btn {
            display: inline-block;
            padding: 12px 40px;
            font-size: 18px;
            background-color: #26d0ce;
            color: white;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background-color: #1a2980;
        }

        #excelFile {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-name {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 15px;
            display: block;
        }

        .parse-btn {
            padding: 10px 30px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            background-color: #1a2980;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .parse-btn:hover {
            background-color: #27ae60;
        }

        .tip-text {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .name-count-tip {
            font-size: 18px;
            color: #27ae60;
            font-weight: 600;
            margin-top: 10px;
        }

        /* æ˜¾ç¤ºåŒºåŸŸï¼ˆæ•°å­—/å§“åï¼‰ */
        .display-area {
            font-size: 40px;
            font-weight: bold;
            color: #e74c3c;
            margin: 40px 0;
            min-height: 280px;
            line-height: 60px;
            border: 6px solid #26d0ce;
            border-radius: 20px;
            background-color: #f8f9fa;
            letter-spacing: 4px;
            box-shadow: inset 0 0 25px rgba(0,0,0,0.08);
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .winner-item {
            background-color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 5px;
        }

        /* æŠ½å¥–æŒ‰é’®æ ·å¼ï¼ˆå•æŒ‰é’®ï¼‰ */
        .lottery-btn {
            padding: 25px 80px;
            font-size: 32px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
            min-width: 300px;
        }
        /* å¼€å§‹æŠ½å¥–æ ·å¼ï¼ˆç»¿è‰²ï¼‰ */
        .lottery-btn.start {
            background-color: #27ae60;
            color: white;
        }
        .lottery-btn.start:hover {
            background-color: #219653;
            transform: scale(1.05);
        }
        /* åœæ­¢æŠ½å¥–æ ·å¼ï¼ˆçº¢è‰²ï¼‰ */
        .lottery-btn.stop {
            background-color: #e74c3c;
            color: white;
        }
        .lottery-btn.stop:hover {
            background-color: #d32f2f;
            transform: scale(1.05);
        }

        /* ä¸­å¥–æç¤º */
        .win-tip {
            font-size: 36px;
            color: #f39c12;
            margin: 30px 0 0;
            font-weight: bold;
            display: none;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.15);
            animation: bounce 1s ease infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-12px); }
        }

        /* ç®¡ç†å…¥å£ */
        .admin-entrance {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: rgba(26, 41, 128, 0.8);
            color: white;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            z-index: 999;
        }

        .admin-entrance:hover {
            background-color: #1a2980;
        }

        /* è½®æ•°æ˜¾ç¤ºæ ·å¼ï¼ˆæ–°å¢ï¼‰ */
        .round-display {
            font-size: 20px;
            color: #1a2980;
            margin: 10px 0 20px;
            font-weight: 600;
        }

        /* å“åº”å¼é€‚é… */
        @media (max-width: 1024px) {
            .main-wrap {
                flex-direction: column;
                align-items: center;
            }
            .lottery-container {
                min-width: 100%;
                padding: 40px 30px;
            }
            .win-list-aside {
                width: 100%;
                max-height: 300px;
                position: static;
            }
            .lottery-title {
                font-size: 32px;
            }
            .display-area {
                font-size: 28px;
                min-height: 200px;
                line-height: 40px;
                letter-spacing: 2px;
            }
            .lottery-btn {
                padding: 20px 60px;
                font-size: 24px;
                min-width: 200px;
            }
            .range-input {
                width: 100px;
                font-size: 18px;
            }
            .quota-btn {
                padding: 8px 20px;
                font-size: 16px;
            }
            .excel-import {
                padding: 20px;
            }
            .win-tip {
                font-size: 28px;
            }
        }
    </style>
    <!-- å¼•å…¥å¤„ç†Excelçš„ç¬¬ä¸‰æ–¹åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <!-- ç®¡ç†é¡µé¢å…¥å£ -->
    <a href="admin.html" class="admin-entrance">ç®¡ç†åå°</a>

    <!-- ä¸»å®¹å™¨ï¼ŒåŒ…å«æŠ½å¥–åŒºå’Œåå•åŒº -->
    <div class="main-wrap">
        <!-- åŸæœ‰æŠ½å¥–å®¹å™¨ -->
        <div class="lottery-container">
            <h1 class="lottery-title">é‡åº†å¸‚è‚²ä»ä¸­å­¦æ ¡2026å¹´ä¼šæŠ½å¥–</h1>
            
            <!-- æ–°å¢ï¼šå½“å‰æŠ½å¥–è½®æ•°æ˜¾ç¤º -->
            <div class="round-display" id="roundDisplay">å½“å‰æŠ½å¥–è½®æ•°ï¼šç¬¬ 1 è½®</div>
            
            <!-- åˆ‡æ¢æ ‡ç­¾ï¼šæ•°å­—æŠ½å¥–/å§“åæŠ½å¥– -->
            <div class="tab-switch">
                <button class="tab-btn active" data-tab="number-tab">æ•°å­—æŠ½å¥–</button>
                <button class="tab-btn" data-tab="name-tab">æ•™å¸ˆå§“åæŠ½å¥–</button>
            </div>

            <!-- åé¢é€‰æ‹©åŒºåŸŸ -->
            <div class="quota-select">
                <span class="quota-label">æœ¬æ¬¡æŠ½å¥–åé¢ï¼š</span>
                <button class="quota-btn active" data-quota="1">1ä¸ªåé¢</button>
                <button class="quota-btn" data-quota="10">10ä¸ªåé¢</button>
            </div>

            <!-- æ•°å­—æŠ½å¥–é¢æ¿ -->
            <div class="content-panel active" id="number-tab">
                <div class="range-setting">
                    <span class="range-label">æŠ½å¥–èŒƒå›´ï¼š</span>
                    <input type="number" class="range-input" id="minNumInput" value="1" min="1" placeholder="æœ€å°å€¼">
                    <span class="range-separator">-</span>
                    <input type="number" class="range-input" id="maxNumInput" value="99" min="1" placeholder="æœ€å¤§å€¼">
                </div>
            </div>

            <!-- å§“åæŠ½å¥–é¢æ¿ï¼ˆExcelå¯¼å…¥ï¼‰ -->
            <div class="content-panel" id="name-tab">
                <div class="excel-import">
                    <span class="import-label">å¯¼å…¥æ•™å¸ˆå§“åï¼ˆExcelæ–‡ä»¶ï¼‰ï¼š</span>
                    <!-- æ–‡ä»¶ä¸Šä¼ æŒ‰é’® -->
                    <div class="file-upload">
                        <span class="upload-btn">é€‰æ‹©Excelæ–‡ä»¶</span>
                        <input type="file" id="excelFile" accept=".xlsx, .xls">
                    </div>
                    <!-- æ˜¾ç¤ºé€‰ä¸­çš„æ–‡ä»¶å -->
                    <span class="file-name" id="fileName">æœªé€‰æ‹©æ–‡ä»¶</span>
                    <!-- è§£ææŒ‰é’® -->
                    <button class="parse-btn" id="parseExcelBtn" disabled>è§£æExcelåå•</button>
                    <!-- æç¤ºä¿¡æ¯ -->
                    <p class="tip-text">ğŸ“Œ æç¤ºï¼šExcelæ–‡ä»¶è¦æ±‚ - ç¬¬ä¸€åˆ—ä¸ºæ•™å¸ˆå§“åï¼Œæ— è¡¨å¤´ï¼ˆç¤ºä¾‹ï¼šA1=å¼ ä¸‰, A2=æå››, A3=ç‹äº”ï¼‰</p>
                    <p class="tip-text">æ”¯æŒæ ¼å¼ï¼š.xlsx / .xlsï¼Œè¯·å‹¿ä¸Šä¼ ç©ºæ–‡ä»¶æˆ–æ ¼å¼é”™è¯¯çš„æ–‡ä»¶</p>
                    <!-- å§“åæ•°é‡æç¤º -->
                    <p class="name-count-tip" id="nameCountTip">å½“å‰æœªå¯¼å…¥ä»»ä½•å§“å</p>
                </div>
            </div>

            <!-- æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="display-area" id="displayArea">0</div>
            
            <!-- å•æŠ½å¥–æŒ‰é’® -->
            <button class="lottery-btn start" id="lotteryBtn">å¼€å§‹æŠ½å¥–</button>
            
            <!-- ä¸­å¥–æç¤º -->
            <div class="win-tip" id="winTip">æ­å–œä¸­å¥–ï¼ğŸ‰</div>
        </div>

        <!-- å³ä¾§ä¸­å¥–åå•å±•ç¤ºæ¨¡å— -->
        <div class="win-list-aside" id="winListAside">
            <div class="win-list-header">
                <div class="win-list-title">ä¸­å¥–åå•å®æ—¶å±•ç¤º</div>
                <div class="win-list-oper">
                    <button class="list-btn refresh-list-btn" id="refreshListBtn">åˆ·æ–°</button>
                    <button class="list-btn download-list-btn" id="downloadListBtn">ä¸‹è½½åå•</button> <!-- æ–°å¢ï¼šä¸‹è½½æŒ‰é’® -->
                    <button class="list-btn collapse-btn" id="collapseListBtn">æ”¶èµ·</button>
                </div>
            </div>
            <div class="win-list-content" id="winListContent">
                <div class="empty-win-tip">æš‚æ— ä¸­å¥–è®°å½•</div>
            </div>
        </div>
    </div>

    <script>
        // è·å–é¡µé¢å…ƒç´ 
        const tabBtns = document.querySelectorAll('.tab-btn');
        const contentPanels = document.querySelectorAll('.content-panel');
        const displayArea = document.getElementById('displayArea');
        const lotteryBtn = document.getElementById('lotteryBtn');
        const winTip = document.getElementById('winTip');
        const quotaBtns = document.querySelectorAll('.quota-btn');
        const roundDisplay = document.getElementById('roundDisplay'); // æ–°å¢ï¼šè½®æ•°æ˜¾ç¤ºå…ƒç´ 
        const downloadListBtn = document.getElementById('downloadListBtn'); // æ–°å¢ï¼šä¸‹è½½æŒ‰é’®
        
        // æ•°å­—æŠ½å¥–ç›¸å…³å…ƒç´ 
        const minNumInput = document.getElementById('minNumInput');
        const maxNumInput = document.getElementById('maxNumInput');
        
        // Excelå¯¼å…¥ç›¸å…³å…ƒç´ 
        const excelFile = document.getElementById('excelFile');
        const fileName = document.getElementById('fileName');
        const parseExcelBtn = document.getElementById('parseExcelBtn');
        const nameCountTip = document.getElementById('nameCountTip');

        // ä¸­å¥–åå•æ¨¡å—å…ƒç´ 
        const winListAside = document.getElementById('winListAside');
        const winListContent = document.getElementById('winListContent');
        const refreshListBtn = document.getElementById('refreshListBtn');
        const collapseListBtn = document.getElementById('collapseListBtn');

        // å…¨å±€å˜é‡
        let lotteryInterval;       // æŠ½å¥–å®šæ—¶å™¨
        let currentTab = 'number-tab'; // å½“å‰é€‰ä¸­çš„æ ‡ç­¾
        let currentQuota = 1;      // å½“å‰æŠ½å¥–åé¢ï¼ˆ1/10ï¼‰
        let minNumber = 1;         // æ•°å­—æŠ½å¥–æœ€å°å€¼
        let maxNumber = 99;        // æ•°å­—æŠ½å¥–æœ€å¤§å€¼
        let teacherNames = [];     // æ•™å¸ˆå§“ååˆ—è¡¨
        let isNameLotteryReady = false; // å§“åæŠ½å¥–æ˜¯å¦å°±ç»ª
        let selectedFile = null;   // é€‰ä¸­çš„Excelæ–‡ä»¶
        let winList = JSON.parse(localStorage.getItem('lotteryWinList')) || []; // ä¸­å¥–åå•
        let tempWinList = [];      // ä¸´æ—¶ä¸­å¥–åˆ—è¡¨ï¼ˆç”¨äº10åé¢æ»šåŠ¨ï¼‰
        let isLotteryRunning = false; // æŠ½å¥–è¿è¡ŒçŠ¶æ€æ ‡è®°
        let currentRound = parseInt(localStorage.getItem('lotteryCurrentRound')) || 1; // æ–°å¢ï¼šå½“å‰æŠ½å¥–è½®æ•°

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            // æ›´æ–°è½®æ•°æ˜¾ç¤º
            updateRoundDisplay();
            
            // æ¢å¤æ•°å­—èŒƒå›´
            const savedRange = JSON.parse(localStorage.getItem('lotteryRange'));
            if (savedRange) {
                minNumInput.value = savedRange.min;
                maxNumInput.value = savedRange.max;
                minNumber = savedRange.min;
                maxNumber = savedRange.max;
            }
            
            // æ¢å¤æ•™å¸ˆå§“ååˆ—è¡¨
            const savedNames = JSON.parse(localStorage.getItem('teacherNames'));
            if (savedNames && savedNames.length > 0) {
                teacherNames = savedNames;
                isNameLotteryReady = true;
                if (currentTab === 'name-tab') {
                    nameCountTip.textContent = `âœ… å·²å¯¼å…¥ï¼šå…± ${teacherNames.length} ä½æ•™å¸ˆå§“å`;
                    nameCountTip.style.color = '#27ae60';
                    displayArea.textContent = 'åå•å·²å¯¼å…¥ï¼Œå¯å¼€å§‹æŠ½å¥–';
                    displayArea.style.color = '#27ae60';
                }
            }
            
            // æ¢å¤ä¸­å¥–åå•å¹¶æ¸²æŸ“
            const savedWinList = JSON.parse(localStorage.getItem('lotteryWinList'));
            if (savedWinList) {
                winList = savedWinList;
            }
            renderWinListAside(); // æ¸²æŸ“ä¾§è¾¹ä¸­å¥–åå•
        });

        // æ–°å¢ï¼šæ›´æ–°è½®æ•°æ˜¾ç¤º
        function updateRoundDisplay() {
            roundDisplay.textContent = `å½“å‰æŠ½å¥–è½®æ•°ï¼šç¬¬ ${currentRound} è½®`;
            localStorage.setItem('lotteryCurrentRound', currentRound);
        }

        // 1. æ ‡ç­¾åˆ‡æ¢é€»è¾‘
        tabBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                stopLotteryOnly(); // ä»…åœæ­¢æ»šåŠ¨ï¼Œä¸è®°å½•åå•
                tabBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTab = this.getAttribute('data-tab');
                contentPanels.forEach(panel => {
                    panel.classList.remove('active');
                    if (panel.id === currentTab) {
                        panel.classList.add('active');
                    }
                });
                // é‡ç½®æ˜¾ç¤ºåŒºåŸŸå’Œä¸´æ—¶åˆ—è¡¨
                displayArea.textContent = currentTab === 'number-tab' ? '0' : 'è¯·å¯¼å…¥Excelåå•';
                displayArea.style.color = '#e74c3c';
                winTip.style.display = 'none';
                tempWinList = [];
            });
        });

        // 2. æŠ½å¥–åé¢åˆ‡æ¢é€»è¾‘
        quotaBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                stopLotteryOnly(); // ä»…åœæ­¢æ»šåŠ¨ï¼Œä¸è®°å½•åå•
                quotaBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentQuota = parseInt(this.getAttribute('data-quota'));
                // é‡ç½®æ˜¾ç¤ºåŒºåŸŸå’Œä¸´æ—¶åˆ—è¡¨
                displayArea.textContent = currentTab === 'number-tab' ? '0' : 'è¯·å¯¼å…¥Excelåå•';
                displayArea.style.color = '#e74c3c';
                winTip.style.display = 'none';
                tempWinList = [];
            });
        });

        // 3. æ•°å­—èŒƒå›´éªŒè¯ä¸æ›´æ–°
        function updateNumberRange() {
            let min = parseInt(minNumInput.value) || 1;
            let max = parseInt(maxNumInput.value) || 99;
            if (min > max) {
                [min, max] = [max, min];
                minNumInput.value = min;
                maxNumInput.value = max;
            }
            minNumber = min;
            maxNumber = max;
            localStorage.setItem('lotteryRange', JSON.stringify({min: minNumber, max: maxNumber}));
        }

        // 4. Excelæ–‡ä»¶é€‰æ‹©é€»è¾‘
        excelFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileExt = file.name.split('.').pop().toLowerCase();
                if (fileExt !== 'xlsx' && fileExt !== 'xls') {
                    alert('è¯·é€‰æ‹©æ­£ç¡®çš„Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsæ ¼å¼ï¼‰ï¼');
                    this.value = '';
                    fileName.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                    parseExcelBtn.disabled = true;
                    selectedFile = null;
                    return;
                }
                selectedFile = file;
                fileName.textContent = `å·²é€‰æ‹©ï¼š${file.name}`;
                parseExcelBtn.disabled = false;
            } else {
                selectedFile = null;
                fileName.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                parseExcelBtn.disabled = true;
            }
        });

        // 5. è§£æExcelæ–‡ä»¶é€»è¾‘
        parseExcelBtn.addEventListener('click', function() {
            if (!selectedFile) {
                alert('è¯·å…ˆé€‰æ‹©æœ‰æ•ˆçš„Excelæ–‡ä»¶ï¼');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    teacherNames = jsonData
                        .map(row => (row[0] ? String(row[0]).trim() : ''))
                        .filter(name => name && name !== 'å§“å' && name !== 'å§“ååˆ—è¡¨');
                    if (teacherNames.length === 0) {
                        alert('æœªä»Excelæ–‡ä»¶ä¸­è§£æåˆ°æœ‰æ•ˆå§“åï¼è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼ˆç¬¬ä¸€åˆ—ä¸ºå§“åï¼Œæ— è¡¨å¤´ï¼‰ã€‚');
                        nameCountTip.textContent = 'å½“å‰æœªå¯¼å…¥ä»»ä½•å§“å';
                        nameCountTip.style.color = '#e74c3c';
                        isNameLotteryReady = false;
                        displayArea.textContent = 'è§£æå¤±è´¥';
                        displayArea.style.color = '#e74c3c';
                        return;
                    }
                    if (teacherNames.length < 10) {
                        alert(`æç¤ºï¼šå½“å‰ä»…å¯¼å…¥${teacherNames.length}ä½æ•™å¸ˆå§“åï¼Œé€‰æ‹©10åé¢æŠ½å¥–æ—¶å¯èƒ½ä¼šé‡å¤æŠ½å–ï¼`);
                    }
                    localStorage.setItem('teacherNames', JSON.stringify(teacherNames));
                    nameCountTip.textContent = `âœ… æˆåŠŸè§£æï¼šå…± ${teacherNames.length} ä½æ•™å¸ˆå§“å`;
                    nameCountTip.style.color = '#27ae60';
                    isNameLotteryReady = true;
                    displayArea.textContent = 'åå•å·²å¯¼å…¥ï¼Œå¯å¼€å§‹æŠ½å¥–';
                    displayArea.style.color = '#27ae60';
                    alert(`ğŸ‰ è§£ææˆåŠŸï¼\nå…±å¯¼å…¥ ${teacherNames.length} ä½æ•™å¸ˆå§“åï¼Œå¯å¼€å§‹æŠ½å¥–ã€‚`);
                } catch (error) {
                    console.error('è§£æExcelå¤±è´¥ï¼š', error);
                    alert('Excelæ–‡ä»¶è§£æå¤±è´¥ï¼å¯èƒ½æ˜¯æ–‡ä»¶æŸåã€æ ¼å¼é”™è¯¯æˆ–éExcelæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥åé‡æ–°ä¸Šä¼ ã€‚');
                    nameCountTip.textContent = 'è§£æå¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ ';
                    nameCountTip.style.color = '#e74c3c';
                    isNameLotteryReady = false;
                }
            };
            reader.readAsArrayBuffer(selectedFile);
        });

        // 6. æŠ½å¥–æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆå¼€å§‹/åœæ­¢åˆ‡æ¢ï¼‰
        lotteryBtn.addEventListener('click', function() {
            if (!isLotteryRunning) {
                startLottery();
            } else {
                stopLotteryWithRecord(); // ç‚¹å‡»åœæ­¢æ—¶ï¼Œæ‰§è¡Œå¸¦è®°å½•çš„å®Œæ•´é€»è¾‘
            }
        });

        // 7. å¿«æ·é”®æ”¯æŒï¼šç©ºæ ¼é”®å¿«é€Ÿå¼€å§‹/åœæ­¢
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                lotteryBtn.click();
            }
        });

        // 8. å¼€å§‹æŠ½å¥–æ ¸å¿ƒå‡½æ•°
        function startLottery() {
            winTip.style.display = 'none';
            displayArea.style.color = '#e74c3c';
            tempWinList = [];
            isLotteryRunning = true;
            lotteryBtn.classList.remove('start');
            lotteryBtn.classList.add('stop');
            lotteryBtn.textContent = 'åœæ­¢æŠ½å¥–';

            if (currentTab === 'number-tab') {
                updateNumberRange();
                const numberCount = maxNumber - minNumber + 1;
                if (currentQuota === 10 && numberCount < 10) {
                    alert(`æç¤ºï¼šå½“å‰æ•°å­—èŒƒå›´ä»…${numberCount}ä¸ªæ•°å­—ï¼Œé€‰æ‹©10åé¢æŠ½å¥–æ—¶å¯èƒ½ä¼šé‡å¤æŠ½å–ï¼`);
                }
                startNumberLottery();
            } else {
                if (!isNameLotteryReady || teacherNames.length === 0) {
                    alert('è¯·å…ˆå¯¼å…¥å¹¶è§£ææœ‰æ•ˆçš„æ•™å¸ˆå§“åExcelåå•ï¼');
                    isLotteryRunning = false;
                    lotteryBtn.classList.remove('stop');
                    lotteryBtn.classList.add('start');
                    lotteryBtn.textContent = 'å¼€å§‹æŠ½å¥–';
                    return;
                }
                if (currentQuota === 10 && teacherNames.length < 10) {
                    alert(`æç¤ºï¼šå½“å‰ä»…å¯¼å…¥${teacherNames.length}ä½æ•™å¸ˆå§“åï¼Œé€‰æ‹©10åé¢æŠ½å¥–æ—¶å¯èƒ½ä¼šé‡å¤æŠ½å–ï¼`);
                }
                startNameLottery();
            }
        }

        // çº¯åœæ­¢æ»šåŠ¨å‡½æ•°ï¼ˆæ— åå•è®°å½•ï¼‰
        function stopLotteryOnly() {
            if (lotteryInterval) {
                clearInterval(lotteryInterval);
                lotteryInterval = null;
            }
            if (isLotteryRunning) {
                isLotteryRunning = false;
                lotteryBtn.classList.remove('stop');
                lotteryBtn.classList.add('start');
                lotteryBtn.textContent = 'å¼€å§‹æŠ½å¥–';
            }
            winTip.style.display = 'none';
        }

        // å¸¦è®°å½•çš„åœæ­¢å‡½æ•°
        function stopLotteryWithRecord() {
            if (lotteryInterval) {
                clearInterval(lotteryInterval);
                lotteryInterval = null;
            }
            isLotteryRunning = false;
            lotteryBtn.classList.remove('stop');
            lotteryBtn.classList.add('start');
            lotteryBtn.textContent = 'å¼€å§‹æŠ½å¥–';
            renderWinResult(); // æ¸²æŸ“ä¸­å¥–ç»“æœ
            winTip.style.display = 'block'; // æ˜¾ç¤ºä¸­å¥–æç¤º
            recordWinList(); // è®°å½•ä¸­å¥–åå•åˆ°æœ¬åœ°å­˜å‚¨
            renderWinListAside(); // åˆ·æ–°ä¾§è¾¹ä¸­å¥–åå•
            
            // æ–°å¢ï¼šæŠ½å¥–è½®æ•°é€’å¢å¹¶æ›´æ–°æ˜¾ç¤º
            currentRound++;
            updateRoundDisplay();
        }

        // 9. æ•°å­—æŠ½å¥– - å¯åŠ¨æ»šåŠ¨
        function startNumberLottery() {
            lotteryInterval = setInterval(() => {
                tempWinList = [];
                for (let i = 0; i < currentQuota; i++) {
                    const randomNum = Math.floor(Math.random() * (maxNumber - minNumber + 1)) + minNumber;
                    tempWinList.push(randomNum.toString().padStart(2, '0'));
                }
                let displayHtml = '';
                tempWinList.forEach(num => {
                    displayHtml += `<span class="winner-item">${num}</span>`;
                });
                displayArea.innerHTML = displayHtml;
            }, 50);
        }

        // 10. å§“åæŠ½å¥– - å¯åŠ¨æ»šåŠ¨
        function startNameLottery() {
            lotteryInterval = setInterval(() => {
                tempWinList = [];
                for (let i = 0; i < currentQuota; i++) {
                    const randomIndex = Math.floor(Math.random() * teacherNames.length);
                    tempWinList.push(teacherNames[randomIndex]);
                }
                let displayHtml = '';
                tempWinList.forEach(name => {
                    displayHtml += `<span class="winner-item">${name}</span>`;
                });
                displayArea.innerHTML = displayHtml;
            }, 80);
        }

        // 11. æ¸²æŸ“æœ€ç»ˆä¸­å¥–ç»“æœ
        function renderWinResult() {
            let displayHtml = '';
            tempWinList.forEach((item) => {
                displayHtml += `<span class="winner-item" style="color: #27ae60; font-size: ${currentQuota === 10 ? '28px' : '60px'};">${item}</span>`;
            });
            displayArea.innerHTML = displayHtml;
        }

        // 12. è®°å½•ä¸­å¥–ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆæ–°å¢è½®æ•°å­—æ®µï¼‰
        function recordWinList() {
            const winTime = new Date().toLocaleString('zh-CN');
            const winType = currentTab === 'number-tab' ? 'æ•°å­—' : 'å§“å';
            // è®°å½•å½“å‰è½®æ•°ï¼ˆæ³¨æ„ï¼šæ˜¯æŠ½å¥–å‰çš„è½®æ•°ï¼Œå› ä¸ºåœæ­¢åæ‰é€’å¢ï¼‰
            const recordRound = currentRound;
            tempWinList.forEach(winContent => {
                winList.push({
                    round: recordRound, // æ–°å¢ï¼šè½®æ•°
                    type: winType,
                    content: winContent,
                    time: winTime,
                    quotaBatch: winTime
                });
            });
            localStorage.setItem('lotteryWinList', JSON.stringify(winList));
        }

        // 13. æ¸²æŸ“ä¾§è¾¹æ ä¸­å¥–åå•ï¼ˆæ–°å¢è½®æ•°å±•ç¤ºï¼‰
        function renderWinListAside() {
            const currentWinList = JSON.parse(localStorage.getItem('lotteryWinList')) || [];
            if (currentWinList.length === 0) {
                winListContent.innerHTML = '<div class="empty-win-tip">æš‚æ— ä¸­å¥–è®°å½•</div>';
                return;
            }
            // å€’åºæ¸²æŸ“ï¼ˆæœ€æ–°ä¸­å¥–åœ¨æœ€ä¸Šæ–¹ï¼‰
            let listHtml = '';
            currentWinList.reverse().forEach(item => {
                listHtml += `
                    <div class="win-item">
                        <div class="win-round">${item.round}è½®</div> <!-- æ–°å¢ï¼šæ˜¾ç¤ºè½®æ•° -->
                        <div class="win-type">${item.type}</div>
                        <div class="win-content">${item.content}</div>
                        <div class="win-time">${item.time}</div>
                    </div>
                `;
            });
            winListContent.innerHTML = listHtml;
        }

        // 14. åå•åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        refreshListBtn.addEventListener('click', function() {
            renderWinListAside();
        });

        // 15. åå•æ”¶èµ·/å±•å¼€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        collapseListBtn.addEventListener('click', function() {
            winListAside.classList.toggle('collapse');
            this.textContent = winListAside.classList.contains('collapse') ? 'å±•å¼€' : 'æ”¶èµ·';
        });

        // æ–°å¢ï¼šä¸‹è½½ä¸­å¥–åå•åŠŸèƒ½
        downloadListBtn.addEventListener('click', function() {
            const winList = JSON.parse(localStorage.getItem('lotteryWinList')) || [];
            if (winList.length === 0) {
                alert('æš‚æ— ä¸­å¥–è®°å½•ï¼Œæ— æ³•ä¸‹è½½ï¼');
                return;
            }
            
            // æ•´ç†ä¸‹è½½æ•°æ®
            const downloadData = winList.map(item => ({
                'æŠ½å¥–è½®æ•°': `${item.round}è½®`,
                'æŠ½å¥–ç±»å‹': item.type,
                'ä¸­å¥–å†…å®¹': item.content,
                'ä¸­å¥–æ—¶é—´': item.time
            }));
            
            // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
            const worksheet = XLSX.utils.json_to_sheet(downloadData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ä¸­å¥–åå•');
            
            // ç”Ÿæˆå¹¶ä¸‹è½½Excelæ–‡ä»¶
            const fileName = `è‚²ä»ä¸­å­¦2026å¹´ä¼šä¸­å¥–åå•_${new Date().getTime()}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            alert(`ğŸ‰ ä¸­å¥–åå•å·²ä¸‹è½½ï¼\næ–‡ä»¶åç§°ï¼š${fileName}\nå…±åŒ…å« ${winList.length} æ¡ä¸­å¥–è®°å½•ã€‚`);
        });
    </script>
</body>
</html>